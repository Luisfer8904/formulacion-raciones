{% extends "operaciones/layout.html" %}
{% block titulo %}⚙️ Opciones{% endblock %}
{% block contenido %}
<div class="container mt-4">
    <h3>Configuración Personal</h3>
    <form action="/guardar_opciones" method="POST">
        
        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Tu nombre completo" value="{{ usuario.nombre or '' }}">
        </div>

        <div class="mb-3">
            <label for="email" class="form-label">Correo Electrónico</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="ejemplo@correo.com" value="{{ usuario.email or '' }}" readonly>
            <small class="form-text text-muted">El correo electrónico no se puede modificar desde aquí.</small>
        </div>

        <!-- Sección de Plan de Suscripción -->
        <div class="mb-4">
            <h5 class="mb-3">Plan de Suscripción</h5>
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="card-title mb-1">Plan Actual: 
                                <span class="badge {% if usuario.get('tipo_plan') == 'personal' %}bg-success{% elif usuario.get('tipo_plan') == 'profesional' %}bg-warning{% elif usuario.get('tipo_plan') == 'premium' %}bg-info{% elif usuario.get('tipo_plan') == 'enterprise' %}bg-dark{% else %}bg-primary{% endif %}">
                                    {{ usuario.get('tipo_plan', 'basico').title() }}
                                </span>
                            </h6>
                            <p class="card-text text-muted mb-0">
                                {% if usuario.get('tipo_plan') == 'personal' %}
                                    Acceso completo con funciones avanzadas - $24/mes
                                {% elif usuario.get('tipo_plan') == 'profesional' %}
                                    Acceso profesional con todas las funciones - $76/mes
                                {% elif usuario.get('tipo_plan') == 'premium' %}
                                    Plan premium con funciones exclusivas
                                {% elif usuario.get('tipo_plan') == 'enterprise' %}
                                    Plan empresarial con soporte dedicado
                                {% else %}
                                    Acceso básico a las funcionalidades de formulación
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="mejorarPlan()">
                                    <i class="fas fa-arrow-up"></i> Mejorar Plan
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="cancelarPlan()">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="pais" class="form-label">País</label>
            <select class="form-select" id="pais" name="pais" required>
                <option value="">Seleccione un país...</option>
                <!-- Centroamérica -->
                <option value="Honduras" {% if usuario.pais == 'Honduras' %}selected{% endif %}>Honduras</option>
                <option value="Guatemala" {% if usuario.pais == 'Guatemala' %}selected{% endif %}>Guatemala</option>
                <option value="El Salvador" {% if usuario.pais == 'El Salvador' %}selected{% endif %}>El Salvador</option>
                <option value="Nicaragua" {% if usuario.pais == 'Nicaragua' %}selected{% endif %}>Nicaragua</option>
                <option value="Costa Rica" {% if usuario.pais == 'Costa Rica' %}selected{% endif %}>Costa Rica</option>
                <option value="Panamá" {% if usuario.pais == 'Panamá' %}selected{% endif %}>Panamá</option>
                <option value="Belice" {% if usuario.pais == 'Belice' %}selected{% endif %}>Belice</option>
                <!-- Norteamérica -->
                <option value="México" {% if usuario.pais == 'México' %}selected{% endif %}>México</option>
                <option value="Estados Unidos" {% if usuario.pais == 'Estados Unidos' %}selected{% endif %}>Estados Unidos</option>
                <option value="Canadá" {% if usuario.pais == 'Canadá' %}selected{% endif %}>Canadá</option>
                <!-- Sudamérica -->
                <option value="Colombia" {% if usuario.pais == 'Colombia' %}selected{% endif %}>Colombia</option>
                <option value="Venezuela" {% if usuario.pais == 'Venezuela' %}selected{% endif %}>Venezuela</option>
                <option value="Ecuador" {% if usuario.pais == 'Ecuador' %}selected{% endif %}>Ecuador</option>
                <option value="Perú" {% if usuario.pais == 'Perú' %}selected{% endif %}>Perú</option>
                <option value="Bolivia" {% if usuario.pais == 'Bolivia' %}selected{% endif %}>Bolivia</option>
                <option value="Brasil" {% if usuario.pais == 'Brasil' %}selected{% endif %}>Brasil</option>
                <option value="Paraguay" {% if usuario.pais == 'Paraguay' %}selected{% endif %}>Paraguay</option>
                <option value="Uruguay" {% if usuario.pais == 'Uruguay' %}selected{% endif %}>Uruguay</option>
                <option value="Argentina" {% if usuario.pais == 'Argentina' %}selected{% endif %}>Argentina</option>
                <option value="Chile" {% if usuario.pais == 'Chile' %}selected{% endif %}>Chile</option>
                <!-- Europa -->
                <option value="España" {% if usuario.pais == 'España' %}selected{% endif %}>España</option>
                <option value="Francia" {% if usuario.pais == 'Francia' %}selected{% endif %}>Francia</option>
                <option value="Alemania" {% if usuario.pais == 'Alemania' %}selected{% endif %}>Alemania</option>
                <option value="Italia" {% if usuario.pais == 'Italia' %}selected{% endif %}>Italia</option>
                <option value="Portugal" {% if usuario.pais == 'Portugal' %}selected{% endif %}>Portugal</option>
                <option value="Reino Unido" {% if usuario.pais == 'Reino Unido' %}selected{% endif %}>Reino Unido</option>
                <!-- Otros -->
                <option value="República Dominicana" {% if usuario.pais == 'República Dominicana' %}selected{% endif %}>República Dominicana</option>
                <option value="Cuba" {% if usuario.pais == 'Cuba' %}selected{% endif %}>Cuba</option>
                <option value="Puerto Rico" {% if usuario.pais == 'Puerto Rico' %}selected{% endif %}>Puerto Rico</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="moneda" class="form-label">Moneda</label>
            <select class="form-select" id="moneda" name="moneda" required>
                <option value="">Seleccione una moneda...</option>
                <!-- Centroamérica -->
                <option value="HNL" {% if usuario.moneda == 'HNL' %}selected{% endif %}>Lempira Hondureño (L)</option>
                <option value="GTQ" {% if usuario.moneda == 'GTQ' %}selected{% endif %}>Quetzal Guatemalteco (Q)</option>
                <option value="USD" {% if usuario.moneda == 'USD' %}selected{% endif %}>Dólar Estadounidense ($)</option>
                <option value="CRC" {% if usuario.moneda == 'CRC' %}selected{% endif %}>Colón Costarricense (₡)</option>
                <option value="NIO" {% if usuario.moneda == 'NIO' %}selected{% endif %}>Córdoba Nicaragüense (C$)</option>
                <option value="PAB" {% if usuario.moneda == 'PAB' %}selected{% endif %}>Balboa Panameño (B/.)</option>
                <!-- Norteamérica -->
                <option value="MXN" {% if usuario.moneda == 'MXN' %}selected{% endif %}>Peso Mexicano ($)</option>
                <option value="CAD" {% if usuario.moneda == 'CAD' %}selected{% endif %}>Dólar Canadiense (C$)</option>
                <!-- Sudamérica -->
                <option value="COP" {% if usuario.moneda == 'COP' %}selected{% endif %}>Peso Colombiano ($)</option>
                <option value="VES" {% if usuario.moneda == 'VES' %}selected{% endif %}>Bolívar Venezolano (Bs.)</option>
                <option value="PEN" {% if usuario.moneda == 'PEN' %}selected{% endif %}>Sol Peruano (S/)</option>
                <option value="BOB" {% if usuario.moneda == 'BOB' %}selected{% endif %}>Boliviano (Bs.)</option>
                <option value="BRL" {% if usuario.moneda == 'BRL' %}selected{% endif %}>Real Brasileño (R$)</option>
                <option value="PYG" {% if usuario.moneda == 'PYG' %}selected{% endif %}>Guaraní Paraguayo (₲)</option>
                <option value="UYU" {% if usuario.moneda == 'UYU' %}selected{% endif %}>Peso Uruguayo ($U)</option>
                <option value="ARS" {% if usuario.moneda == 'ARS' %}selected{% endif %}>Peso Argentino ($)</option>
                <option value="CLP" {% if usuario.moneda == 'CLP' %}selected{% endif %}>Peso Chileno ($)</option>
                <!-- Europa -->
                <option value="EUR" {% if usuario.moneda == 'EUR' %}selected{% endif %}>Euro (€)</option>
                <option value="GBP" {% if usuario.moneda == 'GBP' %}selected{% endif %}>Libra Esterlina (£)</option>
                <!-- Otros -->
                <option value="DOP" {% if usuario.moneda == 'DOP' %}selected{% endif %}>Peso Dominicano (RD$)</option>
                <option value="CUP" {% if usuario.moneda == 'CUP' %}selected{% endif %}>Peso Cubano ($)</option>
                <option value="JPY" {% if usuario.moneda == 'JPY' %}selected{% endif %}>Yen Japonés (¥)</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="unidad_medida" class="form-label">Unidad de Medida</label>
            <select class="form-select" id="unidad_medida" name="unidad_medida" required>
                <option value="">Seleccione...</option>
                <option value="kg" {% if usuario.unidad_medida == 'kg' %}selected{% endif %}>Kilogramos (kg)</option>
                <option value="lb" {% if usuario.unidad_medida == 'lb' %}selected{% endif %}>Libras (lb)</option>
                <option value="ton" {% if usuario.unidad_medida == 'ton' %}selected{% endif %}>Toneladas (ton)</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="idioma" class="form-label">Idioma</label>
            <select class="form-select" id="idioma" name="idioma">
                <option value="es" {% if usuario.idioma == 'es' %}selected{% endif %}>Español</option>
                <option value="en" {% if usuario.idioma == 'en' %}selected{% endif %}>Inglés</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="tema" class="form-label">Tema de la Aplicación</label>
            <select class="form-select" id="tema" name="tema">
                <option value="claro" {% if usuario.tema == 'claro' %}selected{% endif %}>Claro</option>
                <option value="oscuro" {% if usuario.tema == 'oscuro' %}selected{% endif %}>Oscuro</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Guardar Configuración</button>
    </form>
</div>

<!-- Modal para mejorar plan -->
<div class="modal fade" id="modalMejorarPlan" tabindex="-1" aria-labelledby="modalMejorarPlanLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMejorarPlanLabel">Mejorar Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Envía un mensaje a nuestros administradores para solicitar información sobre mejoras a tu plan actual.</p>
                <form id="formMejorarPlan">
                    <div class="mb-3">
                        <label for="tipoMejora" class="form-label">Tipo de consulta</label>
                        <select class="form-select" id="tipoMejora" name="tipo_mejora" required>
                            <option value="">Selecciona una opción...</option>
                            <option value="upgrade">Actualizar a plan superior</option>
                            <option value="funciones">Consultar funciones adicionales</option>
                            <option value="precios">Información sobre precios</option>
                            <option value="personalizado">Plan personalizado</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="mensajeMejora" class="form-label">Mensaje</label>
                        <textarea class="form-control" id="mensajeMejora" name="mensaje" rows="4" 
                                  placeholder="Describe tu consulta o necesidades específicas..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="telefonoContacto" class="form-label">Teléfono de contacto (opcional)</label>
                        <input type="tel" class="form-control" id="telefonoContacto" name="telefono" 
                               placeholder="Número de teléfono para contactarte">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarSolicitudMejora()">
                    <i class="fas fa-paper-plane"></i> Enviar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cancelar plan -->
<div class="modal fade" id="modalCancelarPlan" tabindex="-1" aria-labelledby="modalCancelarPlanLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCancelarPlanLabel">Solicitar Cancelación de Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Información:</strong> Esta es una solicitud de cancelación que será revisada por nuestro equipo. Te contactaremos para confirmar los detalles.
                </div>
                
                <p>¿Deseas solicitar la cancelación de tu plan actual?</p>
                <p class="text-muted">Por favor, ayúdanos a entender mejor tu decisión completando la siguiente información:</p>
                
                <div class="mt-3">
                    <label for="motivoCancelacion" class="form-label">Motivo principal de cancelación <span class="text-danger">*</span></label>
                    <select class="form-select" id="motivoCancelacion" name="motivo_cancelacion" required>
                        <option value="">Selecciona un motivo...</option>
                        <option value="costo">El costo es muy alto para mi presupuesto</option>
                        <option value="funciones">No utilizo todas las funciones del plan</option>
                        <option value="temporal">Necesito una pausa temporal</option>
                        <option value="competencia">Encontré una alternativa mejor</option>
                        <option value="satisfaccion">El servicio no cumple mis expectativas</option>
                        <option value="cambio_negocio">Cambios en mi negocio/necesidades</option>
                        <option value="otro">Otro motivo</option>
                    </select>
                </div>
                
                <div class="mt-3">
                    <label for="comentariosCancelacion" class="form-label">Comentarios adicionales</label>
                    <textarea class="form-control" id="comentariosCancelacion" name="comentarios" rows="4" 
                              placeholder="Cuéntanos más sobre tu decisión. Esto nos ayuda a mejorar nuestro servicio..."></textarea>
                </div>
                
                <div class="mt-3">
                    <label for="telefonoCancelacion" class="form-label">Teléfono de contacto (opcional)</label>
                    <input type="tel" class="form-control" id="telefonoCancelacion" name="telefono" 
                           placeholder="Para contactarte y confirmar la cancelación">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left"></i> Mantener Plan
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmarCancelacion()">
                    <i class="fas fa-paper-plane"></i> Enviar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function mejorarPlan() {
    const modal = new bootstrap.Modal(document.getElementById('modalMejorarPlan'));
    modal.show();
}

function enviarSolicitudMejora() {
    const form = document.getElementById('formMejorarPlan');
    const formData = new FormData(form);
    
    // Validar campos requeridos
    const tipoMejora = formData.get('tipo_mejora');
    const mensaje = formData.get('mensaje');
    
    if (!tipoMejora || !mensaje.trim()) {
        alert('Por favor completa todos los campos obligatorios.');
        return;
    }
    
    // Deshabilitar botón mientras se envía
    const btnEnviar = document.querySelector('#modalMejorarPlan .btn-primary');
    const textoOriginal = btnEnviar.innerHTML;
    btnEnviar.disabled = true;
    btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    
    fetch('/mejorar_plan', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Solicitud enviada exitosamente. Nuestro equipo técnico se pondrá en contacto contigo pronto.');
            // Cerrar modal y limpiar formulario
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalMejorarPlan'));
            modal.hide();
            form.reset();
        } else {
            alert('Error al enviar la solicitud: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la solicitud. Por favor, inténtalo de nuevo.');
    })
    .finally(() => {
        // Restaurar botón
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = textoOriginal;
    });
}

function cancelarPlan() {
    const modal = new bootstrap.Modal(document.getElementById('modalCancelarPlan'));
    modal.show();
}

function confirmarCancelacion() {
    // Obtener datos del formulario de cancelación
    const motivo = document.getElementById('motivoCancelacion').value;
    const comentarios = document.getElementById('comentariosCancelacion').value;
    const telefono = document.getElementById('telefonoCancelacion').value;
    
    // Validar que se haya seleccionado un motivo
    if (!motivo) {
        alert('Por favor selecciona un motivo de cancelación.');
        document.getElementById('motivoCancelacion').focus();
        return;
    }
    
    // Deshabilitar botón mientras se procesa
    const btnConfirmar = document.querySelector('#modalCancelarPlan .btn-danger');
    const textoOriginal = btnConfirmar.innerHTML;
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    
    fetch('/cancelar_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            motivo: motivo,
            comentarios: comentarios,
            telefono: telefono
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal primero
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCancelarPlan'));
            modal.hide();
            
            // Mostrar mensaje de éxito mejorado
            setTimeout(() => {
                alert('✅ Tu solicitud de cancelación ha sido procesada exitosamente.\n\n' +
                      'Nuestro equipo técnico se pondrá en contacto contigo pronto para confirmar los detalles.\n\n' +
                      'Gracias por tu retroalimentación, nos ayuda a mejorar nuestro servicio.');
                location.reload();
            }, 300);
        } else {
            alert('❌ Error al procesar la solicitud: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al enviar la solicitud. Por favor, inténtalo de nuevo.');
    })
    .finally(() => {
        // Restaurar botón
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = textoOriginal;
    });
}
</script>

{% endblock %}
<style>
    .form-label {
        font-weight: 600;
    }
    .form-control, .form-select {
        font-size: 0.85rem;
        padding: 6px 10px;
    }
    .form-control[readonly] {
        background-color: #f8f9fa;
        opacity: 1;
    }
    button[type="submit"] {
        font-size: 0.85rem;
        padding: 6px 12px;
    }
    .card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    .badge {
        font-size: 0.875em;
    }
</style>
