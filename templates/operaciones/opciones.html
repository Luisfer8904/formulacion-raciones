{% extends "operaciones/layout.html" %}
{% block titulo %}‚öôÔ∏è Opciones{% endblock %}
{% block contenido %}
<div class="container mt-4">
    <div class="feedpro-header fade-in-up">
        <h2><i class="fas fa-cog me-2"></i>Configuraci√≥n Personal</h2>
        <small>Personaliza tu experiencia en FeedPro</small>
    </div>
    <form action="/guardar_opciones" method="POST">
        
        <div class="mb-3">
            <label for="nombre" class="form-label">Nombre</label>
            <input type="text" class="form-control" id="nombre" name="nombre" placeholder="Tu nombre completo" value="{{ usuario.nombre or '' }}">
        </div>

        <div class="mb-3">
            <label for="email" class="form-label">Correo Electr√≥nico</label>
            <input type="email" class="form-control" id="email" name="email" placeholder="ejemplo@correo.com" value="{{ usuario.email or '' }}" readonly>
            <small class="form-text text-muted">El correo electr√≥nico no se puede modificar desde aqu√≠.</small>
        </div>

        <!-- Secci√≥n de Plan de Suscripci√≥n -->
        <div class="mb-4">
            <h5 class="mb-3">Plan de Suscripci√≥n</h5>
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="card-title mb-1">Plan Actual: 
                                <span class="badge {% if usuario.get('tipo_plan') == 'personal' %}bg-success{% elif usuario.get('tipo_plan') == 'profesional' %}bg-warning{% elif usuario.get('tipo_plan') == 'premium' %}bg-info{% elif usuario.get('tipo_plan') == 'enterprise' %}bg-dark{% else %}bg-primary{% endif %}">
                                    {{ usuario.get('tipo_plan', 'basico').title() }}
                                </span>
                            </h6>
                            <p class="card-text text-muted mb-0">
                                {% if usuario.get('tipo_plan') == 'personal' %}
                                    Acceso completo con funciones avanzadas - $24/mes
                                {% elif usuario.get('tipo_plan') == 'profesional' %}
                                    Acceso profesional con todas las funciones - $76/mes
                                {% elif usuario.get('tipo_plan') == 'premium' %}
                                    Plan premium con funciones exclusivas
                                {% elif usuario.get('tipo_plan') == 'enterprise' %}
                                    Plan empresarial con soporte dedicado
                                {% else %}
                                    Acceso b√°sico a las funcionalidades de formulaci√≥n
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="mejorarPlan()">
                                    <i class="fas fa-arrow-up"></i> Mejorar Plan
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="cancelarPlan()">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="pais" class="form-label">Pa√≠s</label>
            <select class="form-select" id="pais" name="pais" required>
                <option value="">Seleccione un pa√≠s...</option>
                <!-- Centroam√©rica -->
                <option value="Honduras" {% if usuario.pais == 'Honduras' %}selected{% endif %}>Honduras</option>
                <option value="Guatemala" {% if usuario.pais == 'Guatemala' %}selected{% endif %}>Guatemala</option>
                <option value="El Salvador" {% if usuario.pais == 'El Salvador' %}selected{% endif %}>El Salvador</option>
                <option value="Nicaragua" {% if usuario.pais == 'Nicaragua' %}selected{% endif %}>Nicaragua</option>
                <option value="Costa Rica" {% if usuario.pais == 'Costa Rica' %}selected{% endif %}>Costa Rica</option>
                <option value="Panam√°" {% if usuario.pais == 'Panam√°' %}selected{% endif %}>Panam√°</option>
                <option value="Belice" {% if usuario.pais == 'Belice' %}selected{% endif %}>Belice</option>
                <!-- Norteam√©rica -->
                <option value="M√©xico" {% if usuario.pais == 'M√©xico' %}selected{% endif %}>M√©xico</option>
                <option value="Estados Unidos" {% if usuario.pais == 'Estados Unidos' %}selected{% endif %}>Estados Unidos</option>
                <option value="Canad√°" {% if usuario.pais == 'Canad√°' %}selected{% endif %}>Canad√°</option>
                <!-- Sudam√©rica -->
                <option value="Colombia" {% if usuario.pais == 'Colombia' %}selected{% endif %}>Colombia</option>
                <option value="Venezuela" {% if usuario.pais == 'Venezuela' %}selected{% endif %}>Venezuela</option>
                <option value="Ecuador" {% if usuario.pais == 'Ecuador' %}selected{% endif %}>Ecuador</option>
                <option value="Per√∫" {% if usuario.pais == 'Per√∫' %}selected{% endif %}>Per√∫</option>
                <option value="Bolivia" {% if usuario.pais == 'Bolivia' %}selected{% endif %}>Bolivia</option>
                <option value="Brasil" {% if usuario.pais == 'Brasil' %}selected{% endif %}>Brasil</option>
                <option value="Paraguay" {% if usuario.pais == 'Paraguay' %}selected{% endif %}>Paraguay</option>
                <option value="Uruguay" {% if usuario.pais == 'Uruguay' %}selected{% endif %}>Uruguay</option>
                <option value="Argentina" {% if usuario.pais == 'Argentina' %}selected{% endif %}>Argentina</option>
                <option value="Chile" {% if usuario.pais == 'Chile' %}selected{% endif %}>Chile</option>
                <!-- Europa -->
                <option value="Espa√±a" {% if usuario.pais == 'Espa√±a' %}selected{% endif %}>Espa√±a</option>
                <option value="Francia" {% if usuario.pais == 'Francia' %}selected{% endif %}>Francia</option>
                <option value="Alemania" {% if usuario.pais == 'Alemania' %}selected{% endif %}>Alemania</option>
                <option value="Italia" {% if usuario.pais == 'Italia' %}selected{% endif %}>Italia</option>
                <option value="Portugal" {% if usuario.pais == 'Portugal' %}selected{% endif %}>Portugal</option>
                <option value="Reino Unido" {% if usuario.pais == 'Reino Unido' %}selected{% endif %}>Reino Unido</option>
                <!-- Otros -->
                <option value="Rep√∫blica Dominicana" {% if usuario.pais == 'Rep√∫blica Dominicana' %}selected{% endif %}>Rep√∫blica Dominicana</option>
                <option value="Cuba" {% if usuario.pais == 'Cuba' %}selected{% endif %}>Cuba</option>
                <option value="Puerto Rico" {% if usuario.pais == 'Puerto Rico' %}selected{% endif %}>Puerto Rico</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="moneda" class="form-label">Moneda</label>
            <select class="form-select" id="moneda" name="moneda" required>
                <option value="">Seleccione una moneda...</option>
                <!-- Centroam√©rica -->
                <option value="HNL" {% if usuario.moneda == 'HNL' %}selected{% endif %}>Lempira Hondure√±o (L)</option>
                <option value="GTQ" {% if usuario.moneda == 'GTQ' %}selected{% endif %}>Quetzal Guatemalteco (Q)</option>
                <option value="USD" {% if usuario.moneda == 'USD' %}selected{% endif %}>D√≥lar Estadounidense ($)</option>
                <option value="CRC" {% if usuario.moneda == 'CRC' %}selected{% endif %}>Col√≥n Costarricense (‚Ç°)</option>
                <option value="NIO" {% if usuario.moneda == 'NIO' %}selected{% endif %}>C√≥rdoba Nicarag√ºense (C$)</option>
                <option value="PAB" {% if usuario.moneda == 'PAB' %}selected{% endif %}>Balboa Paname√±o (B/.)</option>
                <!-- Norteam√©rica -->
                <option value="MXN" {% if usuario.moneda == 'MXN' %}selected{% endif %}>Peso Mexicano ($)</option>
                <option value="CAD" {% if usuario.moneda == 'CAD' %}selected{% endif %}>D√≥lar Canadiense (C$)</option>
                <!-- Sudam√©rica -->
                <option value="COP" {% if usuario.moneda == 'COP' %}selected{% endif %}>Peso Colombiano ($)</option>
                <option value="VES" {% if usuario.moneda == 'VES' %}selected{% endif %}>Bol√≠var Venezolano (Bs.)</option>
                <option value="PEN" {% if usuario.moneda == 'PEN' %}selected{% endif %}>Sol Peruano (S/)</option>
                <option value="BOB" {% if usuario.moneda == 'BOB' %}selected{% endif %}>Boliviano (Bs.)</option>
                <option value="BRL" {% if usuario.moneda == 'BRL' %}selected{% endif %}>Real Brasile√±o (R$)</option>
                <option value="PYG" {% if usuario.moneda == 'PYG' %}selected{% endif %}>Guaran√≠ Paraguayo (‚Ç≤)</option>
                <option value="UYU" {% if usuario.moneda == 'UYU' %}selected{% endif %}>Peso Uruguayo ($U)</option>
                <option value="ARS" {% if usuario.moneda == 'ARS' %}selected{% endif %}>Peso Argentino ($)</option>
                <option value="CLP" {% if usuario.moneda == 'CLP' %}selected{% endif %}>Peso Chileno ($)</option>
                <!-- Europa -->
                <option value="EUR" {% if usuario.moneda == 'EUR' %}selected{% endif %}>Euro (‚Ç¨)</option>
                <option value="GBP" {% if usuario.moneda == 'GBP' %}selected{% endif %}>Libra Esterlina (¬£)</option>
                <!-- Otros -->
                <option value="DOP" {% if usuario.moneda == 'DOP' %}selected{% endif %}>Peso Dominicano (RD$)</option>
                <option value="CUP" {% if usuario.moneda == 'CUP' %}selected{% endif %}>Peso Cubano ($)</option>
                <option value="JPY" {% if usuario.moneda == 'JPY' %}selected{% endif %}>Yen Japon√©s (¬•)</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="unidad_medida" class="form-label">Unidad de Medida</label>
            <select class="form-select" id="unidad_medida" name="unidad_medida" required>
                <option value="">Seleccione...</option>
                <option value="kg" {% if usuario.unidad_medida == 'kg' %}selected{% endif %}>Kilogramos (kg)</option>
                <option value="lb" {% if usuario.unidad_medida == 'lb' %}selected{% endif %}>Libras (lb)</option>
                <option value="ton" {% if usuario.unidad_medida == 'ton' %}selected{% endif %}>Toneladas (ton)</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="idioma" class="form-label">Idioma</label>
            <select class="form-select" id="idioma" name="idioma">
                <option value="es" {% if usuario.idioma == 'es' %}selected{% endif %}>Espa√±ol</option>
                <option value="en" {% if usuario.idioma == 'en' %}selected{% endif %}>Ingl√©s</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="tema" class="form-label">Tema de la Aplicaci√≥n</label>
            <select class="form-select" id="tema" name="tema">
                <option value="claro" {% if usuario.tema == 'claro' %}selected{% endif %}>Claro</option>
                <option value="oscuro" {% if usuario.tema == 'oscuro' %}selected{% endif %}>Oscuro</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Guardar Configuraci√≥n</button>
    </form>

    <!-- Nueva secci√≥n: Gesti√≥n de Datos -->
    <div class="mt-5">
        <div class="feedpro-header fade-in-up">
            <h3><i class="fas fa-database me-2"></i>Gesti√≥n de Datos</h3>
            <small>Importa y exporta nutrientes e ingredientes masivamente</small>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-download text-success me-2"></i>Descargar Plantilla
                        </h5>
                        <p class="card-text">
                            Descarga una plantilla de Excel con la estructura correcta para cargar nutrientes e ingredientes con sus propiedades.
                        </p>
                        <div class="d-grid">
                            <button type="button" class="btn btn-success" onclick="descargarPlantilla()">
                                <i class="fas fa-file-excel me-2"></i>Descargar Plantilla Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-upload text-primary me-2"></i>Cargar Datos
                        </h5>
                        <p class="card-text">
                            Carga nutrientes e ingredientes desde un archivo Excel. Aseg√∫rate de usar la plantilla descargada.
                        </p>
                        <form id="formCargarDatos" enctype="multipart/form-data">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="archivoExcel" name="archivo" 
                                       accept=".xlsx,.xls" required>
                                <div class="form-text">Solo archivos Excel (.xlsx, .xls)</div>
                            </div>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="cargarDatos()">
                                    <i class="fas fa-upload me-2"></i>Cargar Datos
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n adicional -->
        <div class="alert alert-info mt-4">
            <h6><i class="fas fa-info-circle me-2"></i>Informaci√≥n importante:</h6>
            <ul class="mb-0">
                <li><strong>Plantilla:</strong> Descarga primero la plantilla para conocer la estructura correcta</li>
                <li><strong>Formato:</strong> La plantilla incluye 3 hojas: Nutrientes, Ingredientes e Ingredientes_Nutrientes</li>
                <li><strong>Validaci√≥n:</strong> Los datos ser√°n validados antes de ser guardados</li>
                <li><strong>Duplicados:</strong> Los elementos existentes ser√°n actualizados, no duplicados</li>
            </ul>
        </div>
    </div>
</div>

<!-- Modal para mejorar plan -->
<div class="modal fade" id="modalMejorarPlan" tabindex="-1" aria-labelledby="modalMejorarPlanLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMejorarPlanLabel">Mejorar Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Env√≠a un mensaje a nuestros administradores para solicitar informaci√≥n sobre mejoras a tu plan actual.</p>
                <form id="formMejorarPlan">
                    <div class="mb-3">
                        <label for="tipoMejora" class="form-label">Tipo de consulta</label>
                        <select class="form-select" id="tipoMejora" name="tipo_mejora" required>
                            <option value="">Selecciona una opci√≥n...</option>
                            <option value="upgrade">Actualizar a plan superior</option>
                            <option value="funciones">Consultar funciones adicionales</option>
                            <option value="precios">Informaci√≥n sobre precios</option>
                            <option value="personalizado">Plan personalizado</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="mensajeMejora" class="form-label">Mensaje</label>
                        <textarea class="form-control" id="mensajeMejora" name="mensaje" rows="4" 
                                  placeholder="Describe tu consulta o necesidades espec√≠ficas..." required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="telefonoContacto" class="form-label">Tel√©fono de contacto (opcional)</label>
                        <input type="tel" class="form-control" id="telefonoContacto" name="telefono" 
                               placeholder="N√∫mero de tel√©fono para contactarte">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="enviarSolicitudMejora()">
                    <i class="fas fa-paper-plane"></i> Enviar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para cancelar plan -->
<div class="modal fade" id="modalCancelarPlan" tabindex="-1" aria-labelledby="modalCancelarPlanLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCancelarPlanLabel">Solicitar Cancelaci√≥n de Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Informaci√≥n:</strong> Esta es una solicitud de cancelaci√≥n que ser√° revisada por nuestro equipo. Te contactaremos para confirmar los detalles.
                </div>
                
                <p>¬øDeseas solicitar la cancelaci√≥n de tu plan actual?</p>
                <p class="text-muted">Por favor, ay√∫danos a entender mejor tu decisi√≥n completando la siguiente informaci√≥n:</p>
                
                <div class="mt-3">
                    <label for="motivoCancelacion" class="form-label">Motivo principal de cancelaci√≥n <span class="text-danger">*</span></label>
                    <select class="form-select" id="motivoCancelacion" name="motivo_cancelacion" required>
                        <option value="">Selecciona un motivo...</option>
                        <option value="costo">El costo es muy alto para mi presupuesto</option>
                        <option value="funciones">No utilizo todas las funciones del plan</option>
                        <option value="temporal">Necesito una pausa temporal</option>
                        <option value="competencia">Encontr√© una alternativa mejor</option>
                        <option value="satisfaccion">El servicio no cumple mis expectativas</option>
                        <option value="cambio_negocio">Cambios en mi negocio/necesidades</option>
                        <option value="otro">Otro motivo</option>
                    </select>
                </div>
                
                <div class="mt-3">
                    <label for="comentariosCancelacion" class="form-label">Comentarios adicionales</label>
                    <textarea class="form-control" id="comentariosCancelacion" name="comentarios" rows="4" 
                              placeholder="Cu√©ntanos m√°s sobre tu decisi√≥n. Esto nos ayuda a mejorar nuestro servicio..."></textarea>
                </div>
                
                <div class="mt-3">
                    <label for="telefonoCancelacion" class="form-label">Tel√©fono de contacto (opcional)</label>
                    <input type="tel" class="form-control" id="telefonoCancelacion" name="telefono" 
                           placeholder="Para contactarte y confirmar la cancelaci√≥n">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left"></i> Mantener Plan
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmarCancelacion()">
                    <i class="fas fa-paper-plane"></i> Enviar Solicitud
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function mejorarPlan() {
    const modal = new bootstrap.Modal(document.getElementById('modalMejorarPlan'));
    modal.show();
}

function enviarSolicitudMejora() {
    const form = document.getElementById('formMejorarPlan');
    const formData = new FormData(form);
    
    // Validar campos requeridos
    const tipoMejora = formData.get('tipo_mejora');
    const mensaje = formData.get('mensaje');
    
    if (!tipoMejora || !mensaje.trim()) {
        alert('Por favor completa todos los campos obligatorios.');
        return;
    }
    
    // Deshabilitar bot√≥n mientras se env√≠a
    const btnEnviar = document.querySelector('#modalMejorarPlan .btn-primary');
    const textoOriginal = btnEnviar.innerHTML;
    btnEnviar.disabled = true;
    btnEnviar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    
    fetch('/mejorar_plan', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Solicitud enviada exitosamente. Nuestro equipo t√©cnico se pondr√° en contacto contigo pronto.');
            // Cerrar modal y limpiar formulario
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalMejorarPlan'));
            modal.hide();
            form.reset();
        } else {
            alert('Error al enviar la solicitud: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la solicitud. Por favor, int√©ntalo de nuevo.');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btnEnviar.disabled = false;
        btnEnviar.innerHTML = textoOriginal;
    });
}

function cancelarPlan() {
    const modal = new bootstrap.Modal(document.getElementById('modalCancelarPlan'));
    modal.show();
}

function confirmarCancelacion() {
    // Obtener datos del formulario de cancelaci√≥n
    const motivo = document.getElementById('motivoCancelacion').value;
    const comentarios = document.getElementById('comentariosCancelacion').value;
    const telefono = document.getElementById('telefonoCancelacion').value;
    
    // Validar que se haya seleccionado un motivo
    if (!motivo) {
        alert('Por favor selecciona un motivo de cancelaci√≥n.');
        document.getElementById('motivoCancelacion').focus();
        return;
    }
    
    // Deshabilitar bot√≥n mientras se procesa
    const btnConfirmar = document.querySelector('#modalCancelarPlan .btn-danger');
    const textoOriginal = btnConfirmar.innerHTML;
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
    
    fetch('/cancelar_plan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            motivo: motivo,
            comentarios: comentarios,
            telefono: telefono
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar modal primero
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCancelarPlan'));
            modal.hide();
            
            // Mostrar mensaje de √©xito mejorado
            setTimeout(() => {
                alert('‚úÖ Tu solicitud de cancelaci√≥n ha sido procesada exitosamente.\n\n' +
                      'Nuestro equipo t√©cnico se pondr√° en contacto contigo pronto para confirmar los detalles.\n\n' +
                      'Gracias por tu retroalimentaci√≥n, nos ayuda a mejorar nuestro servicio.');
                location.reload();
            }, 300);
        } else {
            alert('‚ùå Error al procesar la solicitud: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al enviar la solicitud. Por favor, int√©ntalo de nuevo.');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = textoOriginal;
    });
}

// Nuevas funciones para gesti√≥n de datos
function descargarPlantilla() {
    // Deshabilitar bot√≥n mientras se procesa
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';
    
    // Crear enlace de descarga
    const link = document.createElement('a');
    link.href = '/descargar_plantilla_nutrientes_ingredientes';
    link.download = 'plantilla_nutrientes_ingredientes.xlsx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restaurar bot√≥n despu√©s de un breve delay
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    }, 2000);
}

function cargarDatos() {
    const fileInput = document.getElementById('archivoExcel');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Por favor selecciona un archivo Excel.');
        return;
    }
    
    // Validar tipo de archivo
    const allowedTypes = [
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'application/vnd.ms-excel'
    ];
    
    if (!allowedTypes.includes(file.type)) {
        alert('Por favor selecciona un archivo Excel v√°lido (.xlsx o .xls).');
        return;
    }
    
    // Deshabilitar bot√≥n mientras se procesa
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cargando...';
    
    // Crear FormData y enviar archivo
    const formData = new FormData();
    formData.append('archivo', file);
    
    fetch('/cargar_nutrientes_ingredientes', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Datos cargados exitosamente!\n\n` +
                  `Nutrientes procesados: ${data.nutrientes_procesados || 0}\n` +
                  `Ingredientes procesados: ${data.ingredientes_procesados || 0}\n` +
                  `Relaciones nutriente-ingrediente: ${data.relaciones_procesadas || 0}`);
            
            // Limpiar el input de archivo
            fileInput.value = '';
        } else {
            alert('‚ùå Error al cargar los datos: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al cargar el archivo. Por favor, int√©ntalo de nuevo.');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}

// Funciones para gesti√≥n de datos
function descargarPlantilla() {
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    
    // Mostrar estado de carga
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando plantilla...';
    
    // Crear enlace de descarga
    const link = document.createElement('a');
    link.href = '/descargar_plantilla_nutrientes_ingredientes';
    link.download = 'plantilla_nutrientes_ingredientes.xlsx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Restaurar bot√≥n despu√©s de un momento
    setTimeout(() => {
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    }, 2000);
}

function cargarDatos() {
    const form = document.getElementById('formCargarDatos');
    const archivo = document.getElementById('archivoExcel');
    const btn = event.target;
    const textoOriginal = btn.innerHTML;
    
    if (!archivo.files[0]) {
        alert('Por favor, selecciona un archivo Excel.');
        return;
    }
    
    // Validar tipo de archivo
    const fileName = archivo.files[0].name;
    const fileExtension = fileName.split('.').pop().toLowerCase();
    if (!['xlsx', 'xls'].includes(fileExtension)) {
        alert('Por favor, selecciona un archivo Excel v√°lido (.xlsx o .xls).');
        return;
    }
    
    // Mostrar estado de carga
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando archivo...';
    
    // Crear FormData
    const formData = new FormData();
    formData.append('archivo', archivo.files[0]);
    
    // Enviar archivo
    fetch('/cargar_nutrientes_ingredientes', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Datos cargados exitosamente!\n\n` +
                  `üìä Resumen:\n` +
                  `‚Ä¢ Nutrientes: ${data.stats.nutrientes} procesados\n` +
                  `‚Ä¢ Ingredientes: ${data.stats.ingredientes} procesados\n` +
                  `‚Ä¢ Relaciones: ${data.stats.relaciones} procesadas\n\n` +
                  `Los datos han sido guardados en tu cuenta.`);
            
            // Limpiar formulario
            form.reset();
        } else {
            alert('‚ùå Error al procesar el archivo:\n\n' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error al cargar el archivo. Por favor, int√©ntalo de nuevo.');
    })
    .finally(() => {
        // Restaurar bot√≥n
        btn.disabled = false;
        btn.innerHTML = textoOriginal;
    });
}
</script>

{% endblock %}

<style>
    .formulador-header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .formulador-header h2 {
        margin: 0;
        font-weight: 700;
    }
    
    .formulador-header small {
        opacity: 0.8;
        display: block;
        margin-top: 5px;
    }
    
    .form-label {
        font-weight: 600;
    }
    .form-control, .form-select {
        font-size: 0.85rem;
        padding: 6px 10px;
    }
    .form-control[readonly] {
        background-color: #f8f9fa;
        opacity: 1;
    }
    button
