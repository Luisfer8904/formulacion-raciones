{% extends "operaciones/layout.html" %}

{% block contenido %}
<!-- CSS específico para correcciones de Safari -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/safari-fixes.css') }}">
<!-- CSS para sistema de notificaciones de optimización -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/notificaciones.css') }}">
<div style="height: calc(100vh - 60px); overflow-y: auto; padding-bottom: 100px;">
<div class="container mt-4">
  <!-- Header moderno -->
  <div class="formulador-header">
    <h2><i class="fas fa-balance-scale me-2"></i>Formulación y Control de Mezclas</h2>
    <small>Sistema de Formulación Nutricional Profesional</small>
  </div>

  <!-- Información básica de la mezcla -->
  <div class="info-section">
    <h5 class="section-title"><i class="fas fa-info-circle me-2"></i>Información de la Mezcla</h5>
    <div class="row">
      <div class="col-md-3">
        <label for="nombre-mezcla" class="form-label">Nombre de la Mezcla:</label>
        <input type="text" class="form-control form-control-sm" id="nombre-mezcla" placeholder="Ej: Bovinos Engorde 14%" value="{{ mezcla.nombre if mezcla }}">
      </div>
      <div class="col-md-3">
        <label for="tipo-animales" class="form-label">Tipo de Animales:</label>
        <input type="text" class="form-control form-control-sm" id="tipo-animales" placeholder="Ej: Bovinos" value="{{ mezcla.tipo_animales if mezcla }}">
      </div>
      <div class="col-md-3">
        <label for="etapa-produccion" class="form-label">Etapa de Producción:</label>
        <input type="text" class="form-control form-control-sm" id="etapa-produccion" placeholder="Ej: Engorde" value="{{ mezcla.etapa_produccion if mezcla }}">
      </div>
      <div class="col-md-3">
        <label for="observaciones" class="form-label">Observaciones:</label>
        <input type="text" class="form-control form-control-sm" id="observaciones" placeholder="Opcional" value="{{ mezcla.observaciones if mezcla }}">
      </div>
    </div>
  </div>

  <!-- Tamaño de la bachada -->
  <div class="mb-3">
    <label for="tamano-bachada" class="form-label">Tamaño de la Bachada ({{ config_usuario.unidad_medida }}):</label>
    <input type="number" class="form-control form-control-sm w-25" id="tamano-bachada" value="{{ mezcla.tamano_bachada if mezcla else 100 }}" oninput="actualizarValoresBachada()">
  </div>

  <!-- Botones de acción -->
  <div class="d-flex justify-content-start align-items-center gap-2 mt-2">
    <button class="btn btn-secondary btn-sm" onclick="optimizarMezcla()"><i class="bi bi-graph-up-arrow"></i> Optimizar</button>
    <button class="btn btn-success btn-sm" onclick="guardarMezcla()"><i class="bi bi-save"></i> Guardar</button>
    <button class="btn btn-primary btn-sm" onclick="guardarComo()">
      <i class="bi bi-pencil-square"></i> Guardar Como...
    </button>
    <a href="{{ url_for('mezclas_bp.lista_mezclas') }}" class="btn btn-info btn-sm text-white">
      <i class="bi bi-folder2-open"></i> Cargar
    </a>
    <button class="btn btn-dark btn-sm" onclick="imprimirTabla()"><i class="bi bi-printer"></i> Imprimir</button>
  </div>

  <!-- Tabla de ingredientes disponibles -->
  <div class="info-section">
    <h5 class="section-title"><i class="fas fa-seedling me-2"></i>Ingredientes Disponibles</h5>
    <div class="table-responsive">
      <table class="table table-bordered table-sm formulador-table">
        <thead class="table-light">
          <tr>
            <th>INGREDIENTE</th>
            <th>INCLUSIÓN (%)</th>
            <th>LÍMITE MÍN. (%)</th>
            <th>LÍMITE MÁX. (%)</th>
            <th>PESO BACHADA ({{ config_usuario.unidad_medida }})</th>
            <th>COSTO ({{ config_usuario.moneda|simbolo_moneda }}/{{ config_usuario.unidad_medida }})</th>
            <th>VALOR TOTAL ({{ config_usuario.moneda|simbolo_moneda }})</th>
            <th>ACCIONES</th>
          </tr>
        </thead>
      <tbody id="tabla-ingredientes">
        <tr>
          <td>
            <select class="form-select form-select-sm select-ingrediente" name="ingrediente_0" onchange="agregarFila(this)">
              <option value="">-- Seleccionar --</option>
              {% if minerales %}
                {% for ing in minerales %}
                  <option value="{{ ing.id }}"
                    data-precio="{{ ing.precio }}"
                    data-ms="{{ ing.ms }}"
                    {% for n in ing.nutrientes %}
                      data-id-{{ n.id }}="{{ n.valor }}"
                    {% endfor %}
                    data-nutrientes='{{ ing.nutrientes | tojson }}'
                  >
                    {{ ing.nombre }}
                  </option>
                {% endfor %}
              {% else %}
                <option disabled>No hay ingredientes disponibles</option>
              {% endif %}
            </select>
          </td>
          <td><input type="number" class="form-control form-control-sm" name="inclusion_0" min="0" max="100" step="0.0001" oninput="actualizarValores(this)"></td>
          <td><input type="number" class="form-control form-control-sm" name="min_0" step="0.0001"></td>
          <td><input type="number" class="form-control form-control-sm" name="max_0" step="0.0001"></td>
          <td><input type="number" class="form-control form-control-sm" name="peso_bachada_0" step="0.01" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="costo_ingrediente_0" step="0.01" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="valor_0" step="0.01" readonly></td>
          <td>
            <div class="btn-action-container">
              <button type="button" class="btn-action btn-action-danger" onclick="eliminarFila(this)" title="Eliminar ingrediente">
                <i class="fas fa-times"></i>
              </button>
              <button type="button" class="btn-action btn-action-info" onclick="mostrarInfo(this)" title="Ver información">
                <i class="fas fa-info"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
      </table>
    </div>

    <!-- Suma Inclusión y Materia Seca -->
    <div class="mt-3 d-flex justify-content-between align-items-center">
      <div class="text-start">
        <strong>Suma Inclusión: </strong>
        <span id="suma-inclusion" class="text-success fw-bold">0</span> (%)
        <span class="mx-3">|</span>
        <strong>Materia Seca Total: </strong>
        <span id="materia-seca-total" class="text-primary fw-bold">0.00</span> (%)
      </div>
      <div class="text-end">
        <strong>Total de la mezcla ({{ config_usuario.moneda|simbolo_moneda }}): </strong>
        <span id="suma-total" class="text-success fw-bold">0.00</span>
      </div>
    </div>
  </div>

  <!-- TABLA DINÁMICA DE NUTRIENTES -->
  <div class="info-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="section-title"><i class="fas fa-pills me-2"></i>Nutrientes y Requerimientos</h5>
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="mostrarSelectorRequerimientos()">
        <i class="fas fa-clipboard-list me-1"></i>Seleccionar Requerimientos
      </button>
    </div>
    
    <!-- Selector de Tipo de Optimización -->
    <div class="optimization-type-selector mb-3">
      <div class="d-flex justify-content-center">
        <div class="btn-group optimization-toggle" role="group" aria-label="Tipo de Optimización">
          <input type="radio" class="btn-check" name="tipoOptimizacion" id="baseHumeda" value="base_humeda" checked>
          <label class="btn btn-outline-success" for="baseHumeda">
            <i class="fas fa-droplet me-1"></i>Base Húmeda (TC)
          </label>
          
          <input type="radio" class="btn-check" name="tipoOptimizacion" id="baseSeca" value="base_seca">
          <label class="btn btn-outline-success" for="baseSeca">
            <i class="fas fa-seedling me-1"></i>Base Seca (BS)
          </label>
        </div>
      </div>
      <div class="text-center mt-2">
        <small class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          Selecciona el tipo de optimización: Base Húmeda (tal como) o Base Seca (materia seca)
        </small>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="table table-bordered table-sm nutrientes-table">
        <thead class="table-light text-center align-middle">
          <tr>
            <th>NUTRIENTE</th>
            <th>UNIDAD</th>
            <th>SUGERIDO</th>
            <th>MÍNIMO</th>
            <th>MÁXIMO</th>
            <th>RESULTADO TC</th>
            <th>RESULTADO BS</th>
            <th>ACCIONES</th>
          </tr>
        </thead>
      <tbody id="tabla-nutrientes">
        <!-- Fila inicial de nutriente -->
        <tr>
          <td>
            <select class="form-select form-select-sm" name="nutriente_0" onchange="actualizarUnidadSugerido(this, 0); verificarUltimaFilaNutriente(0); calcularMinerales();">
              <option value="">-- Seleccionar --</option>
              {% for n in nutrientes %}
                <option value="{{ n.id }}" data-unidad="{{ n.unidad }}" data-sugerido="{{ n.sugerido or 0 }}">{{ n.nombre }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="text" class="form-control form-control-sm" name="unidad_0" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="sugerido_0" step="0.0001" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="min_0" step="0.0001" oninput="calcularMinerales();"></td>
          <td><input type="number" class="form-control form-control-sm" name="max_0" step="0.0001" oninput="calcularMinerales();"></td>
          <td class="text-end"><span id="resultado-tc-0">0.00</span></td>
          <td class="text-end"><span id="resultado-bs-0">0.00</span></td>
          <td class="text-center">
            <div class="btn-action-container">
              <button type="button" class="btn-action btn-action-danger" onclick="eliminarFilaNutriente(this); calcularMinerales();" title="Eliminar nutriente">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
      </table>
    </div>
  </div>

</div>
</div>

<!-- Modal de Información del Ingrediente -->
<div class="modal fade" id="infoIngredienteModal" tabindex="-1" aria-labelledby="infoIngredienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoIngredienteModalLabel">Información del Ingrediente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="contenidoInfoIngrediente">
        <!-- Aquí se cargará la información -->
      </div>
    </div>
  </div>
</div>

<!-- Modal para Seleccionar Requerimientos -->
<div class="modal fade" id="selectorRequerimientosModal" tabindex="-1" aria-labelledby="selectorRequerimientosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="selectorRequerimientosModalLabel">📋 Seleccionar Requerimientos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Selecciona un conjunto de requerimientos predefinido para cargar automáticamente en la tabla de nutrientes.</p>
        
        <div id="loading-requerimientos" class="text-center" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando requerimientos...</p>
        </div>

        <div id="lista-requerimientos">
          <!-- Los requerimientos se cargarán aquí dinámicamente -->
        </div>

        <div id="preview-nutrientes" class="mt-4" style="display: none;">
          <h6>Vista previa de nutrientes:</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>Nutriente</th>
                  <th>Unidad</th>
                  <th>Valor Sugerido</th>
                </tr>
              </thead>
              <tbody id="preview-nutrientes-body">
                <!-- Los nutrientes se mostrarán aquí -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="aplicar-requerimientos" onclick="aplicarRequerimientosSeleccionados()" disabled>
          ✅ Aplicar Requerimientos
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Guardar Como -->
<div class="modal fade" id="modalGuardarComo" tabindex="-1" aria-labelledby="modalGuardarComoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Guardar Como...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="nombre-existente" class="form-label">Nombre de la fórmula:</label>
        <select class="form-select" id="nombre-existente">
          <option value="">-- Seleccionar Fórmula --</option>
          {% for mezcla_item in mezclas_disponibles %}
            <option value="{{ mezcla_item.nombre }}">{{ mezcla_item.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="confirmarGuardarComo()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Sistema de Notificaciones para Optimización -->
<script src="{{ url_for('static', filename='js/notificaciones-optimizacion.js') }}"></script>

<!-- JavaScript del Formulador -->
<script src="{{ url_for('static', filename='js/formulador/config.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/ingredientes.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/calculos.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/nutrientes.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/optimizacion.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/guardado.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/utilidades.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/eventos.js') }}"></script>

<!-- PATCH PARA LÍMITES DE INGREDIENTES -->
<script src="{{ url_for('static', filename='js/formulador-limites-patch.js') }}"></script>

<!-- Variables de template para JavaScript -->
<script>
// Variables globales del template
window.nutrientesTemplate = {% if nutrientes %}{{ nutrientes|tojson|safe }}{% else %}[]{% endif %};
window.mineralesTemplate = {% if minerales %}{{ minerales|tojson|safe }}{% else %}[]{% endif %};
{% if ingredientes_mezcla %}
window.ingredientesPrecargados = {{ ingredientes_mezcla|tojson|safe }};
{% endif %}
</script>

<!-- Estilos adicionales para el formulador -->
<style>
  .formulador-header {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .formulador-header h2 {
    margin: 0;
    font-weight: 700;
  }
  
  .formulador-header small {
    opacity: 0.8;
    display: block;
    margin-top: 5px;
  }
  
  .info-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid rgba(0,0,0,0.05);
  }
  
  .section-title {
    color: #7CB342;
    font-weight: 700;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #7CB342;
    display: flex;
    align-items: center;
  }
  
  .table th {
    background: #7CB342 !important;
    color: white !important;
    border: none !important;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
    letter-spacing: 0.5px;
  }
  
  .table-light th {
    background: #7CB342 !important;
    color: white !important;
  }
  
  .btn-action-container {
    display: flex;
    gap: 4px;
    align-items: center;
    justify-content: center;
  }
  
  .btn-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    padding: 0;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid transparent;
    transition: all 0.3s ease;
  }
  
  .btn-action:hover {
    transform: scale(1.1);
    opacity: 1;
  }
  
  .btn-action-danger {
    background-color: #dc3545;
    border-color: #dc3545;
    color: #fff;
  }
  
  .btn-action-info {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: #fff;
  }
  
  /* Mejorar los botones de acción principales */
  .btn-sm {
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .btn-sm:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  /* Mejorar los campos de entrada */
  .form-control, .form-select {
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #7CB342;
    box-shadow: 0 0 0 0.2rem rgba(124, 179, 66, 0.25);
  }
  
  /* Estilo para los totales */
  #suma-inclusion, #suma-total {
    font-weight: bold;
    color: #7CB342;
    font-size: 1.1em;
  }
  
  /* Mejorar las tablas */
  .table {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .table tbody tr:hover {
    background-color: rgba(124, 179, 66, 0.05);
  }
  
  /* Estilos para el selector de tipo de optimización */
  .optimization-type-selector {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    padding: 20px;
    border: 2px solid #7CB342;
    box-shadow: 0 2px 8px rgba(124, 179, 66, 0.1);
  }
  
  .optimization-toggle .btn {
    border-radius: 8px;
    font-weight: 600;
    padding: 12px 24px;
    transition: all 0.3s ease;
    border: 2px solid #7CB342;
    color: #7CB342;
    background: white;
  }
  
  .optimization-toggle .btn:hover {
    background: rgba(124, 179, 66, 0.1);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(124, 179, 66, 0.2);
  }
  
  .optimization-toggle .btn-check:checked + .btn {
    background: #7CB342;
    color: white;
    border-color: #7CB342;
    box-shadow: 0 4px 12px rgba(124, 179, 66, 0.3);
  }
  
  .optimization-toggle .btn-check:checked + .btn:hover {
    background: #6da639;
    border-color: #6da639;
  }
  
  .optimization-toggle .btn i {
    font-size: 1.1em;
  }
  
  .optimization-type-selector small {
    font-size: 0.9em;
    font-weight: 500;
  }
</style>

{% endblock %}
