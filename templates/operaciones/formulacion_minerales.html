{% extends "operaciones/layout.html" %}

{% block contenido %}
<div style="height: calc(100vh - 60px); overflow-y: auto; padding-bottom: 100px;">
<div class="container mt-5">
  <h2 class="text-center text-success">üìã Formulaci√≥n y Control de Mezclas</h2>

  <!-- Informaci√≥n b√°sica de la mezcla -->
  <div class="mt-4 p-3 border rounded bg-light">
    <h5>Informaci√≥n de la Mezcla</h5>
    <div class="row">
      <div class="col-md-3">
        <label for="nombre-mezcla" class="form-label">Nombre de la Mezcla:</label>
        <input type="text" class="form-control form-control-sm" id="nombre-mezcla" placeholder="Ej: Bovinos Engorde 14%" value="{{ mezcla.nombre if mezcla }}">
      </div>
      <div class="col-md-3">
        <label for="tipo-animales" class="form-label">Tipo de Animales:</label>
        <input type="text" class="form-control form-control-sm" id="tipo-animales" placeholder="Ej: Bovinos" value="{{ mezcla.tipo_animales if mezcla }}">
      </div>
      <div class="col-md-3">
        <label for="etapa-produccion" class="form-label">Etapa de Producci√≥n:</label>
        <input type="text" class="form-control form-control-sm" id="etapa-produccion" placeholder="Ej: Engorde" value="{{ mezcla.etapa_produccion if mezcla }}">
      </div>
      <div class="col-md-3">
        <label for="observaciones" class="form-label">Observaciones:</label>
        <input type="text" class="form-control form-control-sm" id="observaciones" placeholder="Opcional" value="{{ mezcla.observaciones if mezcla }}">
      </div>
    </div>
  </div>

  <!-- Tama√±o de la bachada -->
  <div class="mb-3">
    <label for="tamano-bachada" class="form-label">Tama√±o de la Bachada ({{ config_usuario.unidad_medida }}):</label>
    <input type="number" class="form-control form-control-sm w-25" id="tamano-bachada" value="{{ mezcla.tamano_bachada if mezcla else 100 }}" oninput="actualizarValoresBachada()">
  </div>

  <!-- Botones de acci√≥n -->
  <div class="d-flex justify-content-start align-items-center gap-2 mt-2">
    <button class="btn btn-secondary btn-sm" onclick="optimizarMezcla()"><i class="bi bi-graph-up-arrow"></i> Optimizar</button>
    <button class="btn btn-success btn-sm" onclick="guardarMezcla()"><i class="bi bi-save"></i> Guardar</button>
    <button class="btn btn-primary btn-sm" onclick="guardarComo()">
      <i class="bi bi-pencil-square"></i> Guardar Como...
    </button>
    <a href="{{ url_for('mezclas_bp.lista_mezclas') }}" class="btn btn-info btn-sm text-white">
      <i class="bi bi-folder2-open"></i> Cargar
    </a>
    <button class="btn btn-dark btn-sm" onclick="imprimirTabla()"><i class="bi bi-printer"></i> Imprimir</button>
  </div>

  <!-- Tabla de ingredientes disponibles -->
  <div class="mt-4">
    <h4>Ingredientes Disponibles</h4>
    <table class="table table-bordered table-sm">
      <thead class="table-light">
        <tr>
          <th>Ingrediente</th>
          <th>Inclusi√≥n (%)</th>
          <th>L√≠mite M√≠n. (%)</th>
          <th>L√≠mite M√°x. (%)</th>
          <th>Peso en Bachada ({{ config_usuario.unidad_medida }})</th>
          <th>Costo Ingrediente ({{ config_usuario.moneda }}/{{ config_usuario.unidad_medida }})</th>
          <th>Valor Total ({{ config_usuario.moneda }})</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-ingredientes">
        <tr>
          <td>
            <select class="form-select form-select-sm select-ingrediente" name="ingrediente_0" onchange="agregarFila(this)">
              <option value="">-- Seleccionar --</option>
              {% if minerales %}
                {% for ing in minerales %}
                  <option value="{{ ing.id }}"
                    data-precio="{{ ing.precio }}"
                    data-ms="{{ ing.ms }}"
                    {% for n in ing.nutrientes %}
                      data-id-{{ n.id }}="{{ n.valor }}"
                    {% endfor %}
                    data-nutrientes='{{ ing.nutrientes | tojson }}'
                  >
                    {{ ing.nombre }}
                  </option>
                {% endfor %}
              {% else %}
                <option disabled>No hay ingredientes disponibles</option>
              {% endif %}
            </select>
          </td>
          <td><input type="number" class="form-control form-control-sm" name="inclusion_0" min="0" max="100" step="0.1" oninput="actualizarValores(this)"></td>
          <td><input type="number" class="form-control form-control-sm" name="min_0" step="0.0001"></td>
          <td><input type="number" class="form-control form-control-sm" name="max_0" step="0.0001"></td>
          <td><input type="number" class="form-control form-control-sm" name="peso_bachada_0" step="0.01" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="costo_ingrediente_0" step="0.01" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="valor_0" step="0.01" readonly></td>
          <td>
            <button type="button" class="btn btn-sm btn-danger" onclick="eliminarFila(this)">‚úñ</button>
            <button type="button" class="btn btn-sm btn-info" onclick="mostrarInfo(this)">‚ÑπÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Suma Inclusi√≥n -->
    <div class="mt-3 text-start">
      <strong>Suma Inclusi√≥n</strong>
      <span id="suma-inclusion">0</span> (%)
    </div>
    <!-- Total General -->
    <div class="mt-3 text-end">
      <strong>Total de la mezcla ({{ config_usuario.moneda }}): </strong>
      <span id="suma-total">0.00</span>
    </div>
  </div>

  <!-- TABLA DIN√ÅMICA DE NUTRIENTES -->
  <div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>üß™ Nutrientes y Requerimientos</h4>
      <button type="button" class="btn btn-outline-primary btn-sm" onclick="mostrarSelectorRequerimientos()">
        üìã Seleccionar Requerimientos
      </button>
    </div>
    
    <table class="table table-bordered table-sm">
      <thead class="table-light text-center align-middle">
        <tr>
          <th>Nutriente</th>
          <th>Unidad</th>
          <th>Sugerido</th>
          <th>M√≠nimo</th>
          <th>M√°ximo</th>
          <th>Resultado TC</th>
          <th>Resultado BS</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-nutrientes">
        <!-- Fila inicial de nutriente -->
        <tr>
          <td>
            <select class="form-select form-select-sm" name="nutriente_0" onchange="actualizarUnidadSugerido(this, 0); verificarUltimaFilaNutriente(0); calcularMinerales();">
              <option value="">-- Seleccionar --</option>
              {% for n in nutrientes %}
                <option value="{{ n.id }}" data-unidad="{{ n.unidad }}" data-sugerido="{{ n.sugerido or 0 }}">{{ n.nombre }}</option>
              {% endfor %}
            </select>
          </td>
          <td><input type="text" class="form-control form-control-sm" name="unidad_0" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="sugerido_0" step="0.0001" readonly></td>
          <td><input type="number" class="form-control form-control-sm" name="min_0" step="0.0001" oninput="calcularMinerales();"></td>
          <td><input type="number" class="form-control form-control-sm" name="max_0" step="0.0001" oninput="calcularMinerales();"></td>
          <td class="text-end"><span id="resultado-tc-0">0.00</span></td>
          <td class="text-end"><span id="resultado-bs-0">0.00</span></td>
          <td class="text-center"><button type="button" class="btn btn-sm btn-danger" onclick="eliminarFilaNutriente(this); calcularMinerales();">‚úñ</button></td>
        </tr>
      </tbody>
    </table>
  </div>

</div>
</div>

<!-- Modal de Informaci√≥n del Ingrediente -->
<div class="modal fade" id="infoIngredienteModal" tabindex="-1" aria-labelledby="infoIngredienteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="infoIngredienteModalLabel">Informaci√≥n del Ingrediente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="contenidoInfoIngrediente">
        <!-- Aqu√≠ se cargar√° la informaci√≥n -->
      </div>
    </div>
  </div>
</div>

<!-- Modal para Seleccionar Requerimientos -->
<div class="modal fade" id="selectorRequerimientosModal" tabindex="-1" aria-labelledby="selectorRequerimientosModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="selectorRequerimientosModalLabel">üìã Seleccionar Requerimientos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted">Selecciona un conjunto de requerimientos predefinido para cargar autom√°ticamente en la tabla de nutrientes.</p>
        
        <div id="loading-requerimientos" class="text-center" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p class="mt-2">Cargando requerimientos...</p>
        </div>

        <div id="lista-requerimientos">
          <!-- Los requerimientos se cargar√°n aqu√≠ din√°micamente -->
        </div>

        <div id="preview-nutrientes" class="mt-4" style="display: none;">
          <h6>Vista previa de nutrientes:</h6>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>Nutriente</th>
                  <th>Unidad</th>
                  <th>Valor Sugerido</th>
                </tr>
              </thead>
              <tbody id="preview-nutrientes-body">
                <!-- Los nutrientes se mostrar√°n aqu√≠ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="aplicar-requerimientos" onclick="aplicarRequerimientosSeleccionados()" disabled>
          ‚úÖ Aplicar Requerimientos
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Guardar Como -->
<div class="modal fade" id="modalGuardarComo" tabindex="-1" aria-labelledby="modalGuardarComoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Guardar Como...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label for="nombre-existente" class="form-label">Nombre de la f√≥rmula:</label>
        <select class="form-select" id="nombre-existente">
          <option value="">-- Seleccionar F√≥rmula --</option>
          {% for mezcla_item in mezclas_disponibles %}
            <option value="{{ mezcla_item.nombre }}">{{ mezcla_item.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="confirmarGuardarComo()">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript del Formulador -->
<script src="{{ url_for('static', filename='js/formulador/config.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/ingredientes.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/calculos.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/nutrientes.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/optimizacion.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/guardado.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/utilidades.js') }}"></script>
<script src="{{ url_for('static', filename='js/formulador/eventos.js') }}"></script>

<!-- Variables de template para JavaScript -->
<script>
// Variables globales del template
window.nutrientesTemplate = {% if nutrientes %}{{ nutrientes|tojson|safe }}{% else %}[]{% endif %};
window.mineralesTemplate = {% if minerales %}{{ minerales|tojson|safe }}{% else %}[]{% endif %};
{% if ingredientes_mezcla %}
window.ingredientesPrecargados = {{ ingredientes_mezcla|tojson|safe }};
{% endif %}
</script>

{% endblock %}
