{% extends "operaciones/layout.html" %}

{% block contenido %}
<!-- Header profesional -->
<div class="feedpro-header fade-in-up">
    <h2><i class="fas fa-tools me-2"></i>Herramientas FeedPro</h2>
    <small>Utilidades avanzadas para optimizar su trabajo en nutrición animal</small>
</div>

<!-- Herramientas Principales -->
<div class="tools-grid fade-in-up">
    <!-- Calculadora Nutricional -->
    <div class="tool-card" onclick="abrirCalculadora()">
        <div class="tool-icon bg-primary">
            <i class="fas fa-calculator"></i>
        </div>
        <div class="tool-content">
            <h5>Calculadora Nutricional</h5>
            <p>Calcule valores nutricionales, conversiones de unidades y análisis rápidos</p>
            <div class="tool-features">
                <span class="feature-tag">Conversiones</span>
                <span class="feature-tag">Análisis</span>
                <span class="feature-tag">Cálculos</span>
            </div>
        </div>
        <div class="tool-status">
            <span class="status-badge status-active">Activo</span>
        </div>
    </div>

    <!-- Conversor de Unidades -->
    <div class="tool-card" onclick="abrirConversor()">
        <div class="tool-icon bg-success">
            <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="tool-content">
            <h5>Conversor de Unidades</h5>
            <p>Convierta entre diferentes unidades de medida nutricional</p>
            <div class="tool-features">
                <span class="feature-tag">Peso</span>
                <span class="feature-tag">Volumen</span>
                <span class="feature-tag">Energía</span>
            </div>
        </div>
        <div class="tool-status">
            <span class="status-badge status-active">Activo</span>
        </div>
    </div>

    <!-- Analizador de Costos -->
    <div class="tool-card" onclick="abrirAnalizadorCostos()">
        <div class="tool-icon bg-warning">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="tool-content">
            <h5>Analizador de Costos</h5>
            <p>Analice la estructura de costos de sus formulaciones</p>
            <div class="tool-features">
                <span class="feature-tag">Costos</span>
                <span class="feature-tag">Márgenes</span>
                <span class="feature-tag">Rentabilidad</span>
            </div>
        </div>
        <div class="tool-status">
            <span class="status-badge status-active">Activo</span>
        </div>
    </div>

    <!-- Validador de Fórmulas -->
    <div class="tool-card" onclick="abrirValidador()">
        <div class="tool-icon bg-info">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="tool-content">
            <h5>Validador de Fórmulas</h5>
            <p>Valide la consistencia y calidad de sus formulaciones</p>
            <div class="tool-features">
                <span class="feature-tag">Validación</span>
                <span class="feature-tag">Calidad</span>
                <span class="feature-tag">Alertas</span>
            </div>
        </div>
        <div class="tool-status">
            <span class="status-badge status-active">Activo</span>
        </div>
    </div>

    <!-- Comparador de Ingredientes -->
    <div class="tool-card" onclick="abrirComparador()">
        <div class="tool-icon bg-secondary">
            <i class="fas fa-balance-scale"></i>
        </div>
        <div class="tool-content">
            <h5>Comparador de Ingredientes</h5>
            <p>Compare perfiles nutricionales entre diferentes ingredientes</p>
            <div class="tool-features">
                <span class="feature-tag">Comparación</span>
                <span class="feature-tag">Perfiles</span>
                <span class="feature-tag">Análisis</span>
            </div>
        </div>
        <div class="tool-status">
            <span class="status-badge status-active">Activo</span>
        </div>
    </div>

    <!-- Calculadora de Aportes Nutricionales -->
    <div class="tool-card" onclick="abrirCalculadoraAportes()">
        <div class="tool-icon bg-success">
            <i class="fas fa-calculator"></i>
        </div>
        <div class="tool-content">
            <h5>Calculadora de Aportes Nutricionales</h5>
            <p>Calcule aportes nutricionales de fórmulas personalizadas por animal</p>
            <div class="tool-features">
                <span class="feature-tag">Aportes</span>
                <span class="feature-tag">Nutrientes</span>
                <span class="feature-tag">Fórmulas</span>
            </div>
        </div>
        <div class="tool-status">
            <span class="status-badge status-active">Activo</span>
        </div>
    </div>

    <!-- Optimizador Avanzado -->
    <div class="tool-card" onclick="abrirOptimizador()">
        <div class="tool-icon bg-danger">
            <i class="fas fa-cogs"></i>
        </div>
        <div class="tool-content">
            <h5>Optimizador Avanzado</h5>
            <p>Herramientas avanzadas de optimización y análisis</p>
            <div class="tool-features">
                <span class="feature-tag">Optimización</span>
                <span class="feature-tag">Algoritmos</span>
                <span class="feature-tag">Avanzado</span>
            </div>
        </div>
        <div class="tool-status">
            <span class="status-badge status-development">En Desarrollo</span>
        </div>
    </div>
</div>

<!-- Herramientas de Análisis -->
<div class="row fade-in-up mt-4">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Herramientas de Análisis</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="analysis-tool" onclick="abrirAnalisisNutricional()">
                            <div class="analysis-icon">
                                <i class="fas fa-microscope"></i>
                            </div>
                            <div class="analysis-content">
                                <h6>Análisis Nutricional Detallado</h6>
                                <p class="mb-0">Análisis profundo de perfiles nutricionales</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analysis-tool" onclick="abrirAnalisisEconomico()">
                            <div class="analysis-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="analysis-content">
                                <h6>Análisis Económico</h6>
                                <p class="mb-0">Evaluación de costos y rentabilidad</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analysis-tool" onclick="abrirAnalisisTendencias()">
                            <div class="analysis-icon">
                                <i class="fas fa-trending-up"></i>
                            </div>
                            <div class="analysis-content">
                                <h6>Análisis de Tendencias</h6>
                                <p class="mb-0">Tendencias de precios y disponibilidad</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analysis-tool" onclick="abrirAnalisisCalidad()">
                            <div class="analysis-icon">
                                <i class="fas fa-award"></i>
                            </div>
                            <div class="analysis-content">
                                <h6>Análisis de Calidad</h6>
                                <p class="mb-0">Evaluación de calidad de ingredientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Estado de Herramientas</h5>
            </div>
            <div class="card-body">
                <div class="tools-stats">
                    <div class="stat-item">
                        <div class="stat-number text-success">6</div>
                        <div class="stat-label">Herramientas Activas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-warning">1</div>
                        <div class="stat-label">En Desarrollo</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number text-info">4</div>
                        <div class="stat-label">Análisis Disponibles</div>
                    </div>
                </div>
                
                <hr>
                
                <div class="recent-usage">
                    <h6 class="mb-3">Uso Reciente</h6>
                    <div class="usage-item">
                        <i class="fas fa-calculator text-primary me-2"></i>
                        <small>Calculadora Nutricional - Hace 2 horas</small>
                    </div>
                    <div class="usage-item">
                        <i class="fas fa-exchange-alt text-success me-2"></i>
                        <small>Conversor de Unidades - Ayer</small>
                    </div>
                    <div class="usage-item">
                        <i class="fas fa-dollar-sign text-warning me-2"></i>
                        <small>Analizador de Costos - Hace 3 días</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales para Herramientas -->
<!-- Modal Calculadora -->
<div class="modal fade" id="calculadoraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-calculator me-2"></i>Calculadora Nutricional</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="calculator-interface">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Conversiones Rápidas</h6>
                            <div class="mb-3">
                                <label class="form-label">Valor a convertir</label>
                                <input type="number" class="form-control" id="valorConvertir" placeholder="Ingrese valor">
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <select class="form-select" id="unidadOrigen">
                                        <option value="kg">Kilogramos</option>
                                        <option value="g">Gramos</option>
                                        <option value="lb">Libras</option>
                                        <option value="oz">Onzas</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="unidadDestino">
                                        <option value="g">Gramos</option>
                                        <option value="kg">Kilogramos</option>
                                        <option value="lb">Libras</option>
                                        <option value="oz">Onzas</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-2" onclick="convertirUnidades()">Convertir</button>
                            <div id="resultadoConversion" class="mt-2"></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Cálculos Nutricionales</h6>
                            <div class="mb-3">
                                <label class="form-label">Proteína Cruda (%)</label>
                                <input type="number" class="form-control" id="proteina" placeholder="% Proteína">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Cantidad (kg)</label>
                                <input type="number" class="form-control" id="cantidad" placeholder="Cantidad en kg">
                            </div>
                            <button class="btn btn-success" onclick="calcularProteina()">Calcular Proteína Total</button>
                            <div id="resultadoProteina" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.herramientas-header {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    padding: 2.5rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    color: white;
    box-shadow: 0 8px 32px rgba(108, 117, 125, 0.2);
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    color: white;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.page-subtitle {
    font-size: 1.1rem;
    margin: 0.5rem 0 0 0;
    color: rgba(255,255,255,0.9);
    font-weight: 400;
}

.tools-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.tool-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
    position: relative;
}

.tool-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    border-color: #6c757d;
}

.tool-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    margin-bottom: 1rem;
}

.tool-content h5 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.tool-content p {
    color: #6c757d;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.tool-features {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.feature-tag {
    background: #f8f9fa;
    color: #6c757d;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.tool-status {
    position: absolute;
    top: 1rem;
    right: 1rem;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-development {
    background: #fff3cd;
    color: #856404;
}

.analysis-tool {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.analysis-tool:hover {
    background: #e9ecef;
    transform: translateX(4px);
}

.analysis-icon {
    width: 40px;
    height: 40px;
    background: #6c757d;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    margin-right: 1rem;
}

.analysis-content h6 {
    margin: 0 0 0.25rem 0;
    font-weight: 600;
}

.analysis-content p {
    font-size: 0.85rem;
    color: #6c757d;
}

.tools-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
}

.stat-label {
    font-size: 0.8rem;
    color: #6c757d;
}

.usage-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}

.calculator-interface {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
}

.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 768px) {
    .tools-grid {
        grid-template-columns: 1fr;
    }
    
    .page-title {
        font-size: 2rem;
    }
    
    .herramientas-header {
        padding: 1.5rem;
    }
}
</style>

<script>
function actualizarHerramientas() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
    btn.disabled = true;
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        mostrarNotificacion('Herramientas actualizadas', 'success');
    }, 1500);
}

function abrirCalculadora() {
    const modal = new bootstrap.Modal(document.getElementById('calculadoraModal'));
    modal.show();
}

function abrirConversor() {
    // Crear modal dinámico para conversor
    const modalHtml = `
        <div class="modal fade" id="conversorModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Conversor de Unidades</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Valor a Convertir</label>
                            <input type="number" class="form-control" id="valorConversorModal" step="0.000001" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">De</label>
                                <select class="form-select" id="unidadOrigenModal" required>
                                    <option value="kg">Kilogramos (kg)</option>
                                    <option value="g">Gramos (g)</option>
                                    <option value="lb">Libras (lb)</option>
                                    <option value="oz">Onzas (oz)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">A</label>
                                <select class="form-select" id="unidadDestinoModal" required>
                                    <option value="kg">Kilogramos (kg)</option>
                                    <option value="g">Gramos (g)</option>
                                    <option value="lb">Libras (lb)</option>
                                    <option value="oz">Onzas (oz)</option>
                                </select>
                            </div>
                        </div>
                        <div id="resultadoConversorModal" class="alert d-none mt-3"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="convertirUnidadesModal()">Convertir</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si existe
    const existingModal = document.getElementById('conversorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('conversorModal'));
    modal.show();
}

function abrirAnalizadorCostos() {
    // Crear modal dinámico para analizador de costos
    const modalHtml = `
        <div class="modal fade" id="analizadorCostosModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-dollar-sign me-2"></i>Analizador de Costos</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarIngredienteCosto()">
                                <i class="fas fa-plus me-1"></i>Agregar Ingrediente
                            </button>
                        </div>
                        <div id="ingredientesCostoModal">
                            <!-- Los ingredientes se agregarán dinámicamente -->
                        </div>
                        <div id="resultadoAnalisisCostosModal" class="mt-3 d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="analizarCostosModal()">Analizar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si existe
    const existingModal = document.getElementById('analizadorCostosModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Agregar primer ingrediente
    setTimeout(() => {
        agregarIngredienteCosto();
    }, 100);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('analizadorCostosModal'));
    modal.show();
}

function abrirValidador() {
    // Crear modal dinámico para validador
    const modalHtml = `
        <div class="modal fade" id="validadorModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Validador de Fórmulas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarIngredienteValidacion()">
                                <i class="fas fa-plus me-1"></i>Agregar Ingrediente
                            </button>
                        </div>
                        <div id="ingredientesValidacionModal">
                            <!-- Los ingredientes se agregarán dinámicamente -->
                        </div>
                        <div id="resultadoValidacionModal" class="mt-3 d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="validarFormulaModal()">Validar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si existe
    const existingModal = document.getElementById('validadorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Agregar primer ingrediente
    setTimeout(() => {
        agregarIngredienteValidacion();
    }, 100);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('validadorModal'));
    modal.show();
}

function abrirComparador() {
    mostrarNotificacion('Comparador de Ingredientes - Funcionalidad en desarrollo', 'info');
}

function abrirOptimizador() {
    mostrarNotificacion('Optimizador Avanzado - En desarrollo', 'warning');
}

function abrirAnalisisNutricional() {
    mostrarNotificacion('Análisis Nutricional - Funcionalidad en desarrollo', 'info');
}

function abrirAnalisisEconomico() {
    mostrarNotificacion('Análisis Económico - Funcionalidad en desarrollo', 'info');
}

function abrirAnalisisTendencias() {
    mostrarNotificacion('Análisis de Tendencias - Funcionalidad en desarrollo', 'info');
}

function abrirAnalisisCalidad() {
    mostrarNotificacion('Análisis de Calidad - Funcionalidad en desarrollo', 'info');
}

function convertirUnidades() {
    const valor = parseFloat(document.getElementById('valorConvertir').value);
    const origen = document.getElementById('unidadOrigen').value;
    const destino = document.getElementById('unidadDestino').value;
    
    if (!valor) {
        document.getElementById('resultadoConversion').innerHTML = 
            '<div class="alert alert-warning">Por favor ingrese un valor válido</div>';
        return;
    }
    
    // Conversiones básicas (ejemplo)
    const conversiones = {
        'kg': { 'g': 1000, 'lb': 2.20462, 'oz': 35.274 },
        'g': { 'kg': 0.001, 'lb': 0.00220462, 'oz': 0.035274 },
        'lb': { 'kg': 0.453592, 'g': 453.592, 'oz': 16 },
        'oz': { 'kg': 0.0283495, 'g': 28.3495, 'lb': 0.0625 }
    };
    
    let resultado;
    if (origen === destino) {
        resultado = valor;
    } else {
        resultado = valor * conversiones[origen][destino];
    }
    
    document.getElementById('resultadoConversion').innerHTML = 
        `<div class="alert alert-success">
            <strong>Resultado:</strong> ${valor} ${origen} = ${resultado.toFixed(4)} ${destino}
        </div>`;
}

function calcularProteina() {
    const proteina = parseFloat(document.getElementById('proteina').value);
    const cantidad = parseFloat(document.getElementById('cantidad').value);
    
    if (!proteina || !cantidad) {
        document.getElementById('resultadoProteina').innerHTML = 
            '<div class="alert alert-warning">Por favor complete todos los campos</div>';
        return;
    }
    
    const proteinaTotal = (proteina / 100) * cantidad;
    
    document.getElementById('resultadoProteina').innerHTML = 
        `<div class="alert alert-success">
            <strong>Proteína Total:</strong> ${proteinaTotal.toFixed(2)} kg<br>
            <small>En ${cantidad} kg de alimento con ${proteina}% de proteína</small>
        </div>`;
}

function mostrarNotificacion(mensaje, tipo) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}

// Funciones para conectar con APIs

function convertirUnidadesModal() {
    const valor = parseFloat(document.getElementById('valorConversorModal').value);
    const origen = document.getElementById('unidadOrigenModal').value;
    const destino = document.getElementById('unidadDestinoModal').value;
    
    if (isNaN(valor)) {
        document.getElementById('resultadoConversorModal').className = 'alert alert-warning';
        document.getElementById('resultadoConversorModal').innerHTML = 'Por favor ingrese un valor válido';
        document.getElementById('resultadoConversorModal').classList.remove('d-none');
        return;
    }
    
    const datos = {
        valor: valor,
        origen: origen,
        destino: destino
    };
    
    fetch('/api/convertir_unidades', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(data => {
        const resultado = document.getElementById('resultadoConversorModal');
        if (data.success) {
            resultado.className = 'alert alert-success';
            resultado.innerHTML = `<strong>Resultado:</strong><br>${data.mensaje}`;
        } else {
            resultado.className = 'alert alert-danger';
            resultado.innerHTML = `<strong>Error:</strong> ${data.error}`;
        }
        resultado.classList.remove('d-none');
    })
    .catch(error => {
        console.error('Error:', error);
        const resultado = document.getElementById('resultadoConversorModal');
        resultado.className = 'alert alert-danger';
        resultado.innerHTML = `<strong>Error:</strong> ${error.message}`;
        resultado.classList.remove('d-none');
    });
}

function agregarIngredienteCosto() {
    const container = document.getElementById('ingredientesCostoModal');
    
    const ingredienteDiv = document.createElement('div');
    ingredienteDiv.className = 'row mb-3 ingrediente-costo';
    ingredienteDiv.innerHTML = `
        <div class="col-md-4">
            <input type="text" class="form-control" placeholder="Nombre del ingrediente" required>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" placeholder="Cantidad (kg)" step="0.01" min="0" required>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" placeholder="Precio/kg" step="0.01" min="0" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngredienteCosto(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(ingredienteDiv);
}

function eliminarIngredienteCosto(btn) {
    btn.closest('.ingrediente-costo').remove();
}

function analizarCostosModal() {
    const ingredientesDiv = document.querySelectorAll('.ingrediente-costo');
    const ingredientes = [];
    
    ingredientesDiv.forEach(div => {
        const inputs = div.querySelectorAll('input');
        const nombre = inputs[0].value;
        const cantidad = parseFloat(inputs[1].value);
        const precio = parseFloat(inputs[2].value);
        
        if (nombre && !isNaN(cantidad) && !isNaN(precio)) {
            ingredientes.push({
                nombre: nombre,
                cantidad: cantidad,
                precio_kg: precio
            });
        }
    });
    
    if (ingredientes.length === 0) {
        const resultado = document.getElementById('resultadoAnalisisCostosModal');
        resultado.className = 'alert alert-warning';
        resultado.innerHTML = 'Por favor agregue al menos un ingrediente válido';
        resultado.classList.remove('d-none');
        return;
    }
    
    fetch('/api/analizar_costos', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ingredientes: ingredientes })
    })
    .then(response => response.json())
    .then(data => {
        const resultado = document.getElementById('resultadoAnalisisCostosModal');
        if (data.success) {
            let html = `
                <div class="alert alert-success">
                    <h6><strong>Análisis de Costos</strong></h6>
                    <p><strong>Costo Total:</strong> $${data.costo_total}</p>
                    <p><strong>Ingrediente más caro:</strong> ${data.ingrediente_mas_caro.nombre} ($${data.ingrediente_mas_caro.costo_total})</p>
                    
                    <h6 class="mt-3">Desglose por Ingrediente:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Ingrediente</th>
                                    <th>Cantidad</th>
                                    <th>Precio/kg</th>
                                    <th>Costo Total</th>
                                    <th>% del Total</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.analisis.forEach(item => {
                html += `
                    <tr>
                        <td>${item.nombre}</td>
                        <td>${item.cantidad} kg</td>
                        <td>$${item.precio_kg}</td>
                        <td>$${item.costo_total}</td>
                        <td>${item.porcentaje}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            resultado.innerHTML = html;
        } else {
            resultado.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${data.error}</div>`;
        }
        resultado.classList.remove('d-none');
    })
    .catch(error => {
        console.error('Error:', error);
        const resultado = document.getElementById('resultadoAnalisisCostosModal');
        resultado.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
        resultado.classList.remove('d-none');
    });
}

function agregarIngredienteValidacion() {
    const container = document.getElementById('ingredientesValidacionModal');
    
    const ingredienteDiv = document.createElement('div');
    ingredienteDiv.className = 'row mb-3 ingrediente-validacion';
    ingredienteDiv.innerHTML = `
        <div class="col-md-6">
            <input type="text" class="form-control" placeholder="Nombre del ingrediente" required>
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control" placeholder="Porcentaje (%)" step="0.01" min="0" max="100" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngredienteValidacion(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(ingredienteDiv);
}

function eliminarIngredienteValidacion(btn) {
    btn.closest('.ingrediente-validacion').remove();
}

function validarFormulaModal() {
    const ingredientesDiv = document.querySelectorAll('.ingrediente-validacion');
    const ingredientes = [];
    
    ingredientesDiv.forEach(div => {
        const inputs = div.querySelectorAll('input');
        const nombre = inputs[0].value;
        const porcentaje = parseFloat(inputs[1].value);
        
        if (nombre && !isNaN(porcentaje)) {
            ingredientes.push({
                nombre: nombre,
                porcentaje: porcentaje
            });
        }
    });
    
    if (ingredientes.length === 0) {
        const resultado = document.getElementById('resultadoValidacionModal');
        resultado.className = 'alert alert-warning';
        resultado.innerHTML = 'Por favor agregue al menos un ingrediente válido';
        resultado.classList.remove('d-none');
        return;
    }
    
    fetch('/api/validar_formula', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ingredientes: ingredientes })
    })
    .then(response => response.json())
    .then(data => {
        const resultado = document.getElementById('resultadoValidacionModal');
        if (data.success) {
            let alertClass = 'alert-success';
            if (data.estado === 'error') alertClass = 'alert-danger';
            else if (data.estado === 'advertencia') alertClass = 'alert-warning';
            
            let html = `
                <div class="alert ${alertClass}">
                    <h6><strong>Resultado de Validación</strong></h6>
                    <p><strong>Estado:</strong> ${data.estado.toUpperCase()}</p>
                    <p><strong>Total de ingredientes:</strong> ${data.total_ingredientes}</p>
                    <p><strong>Suma de porcentajes:</strong> ${data.total_porcentaje}%</p>
            `;
            
            if (data.validaciones.length > 0) {
                html += '<h6 class="mt-3">Validaciones:</h6><ul>';
                data.validaciones.forEach(validacion => {
                    html += `<li>${validacion}</li>`;
                });
                html += '</ul>';
            }
            
            if (data.errores.length > 0) {
                html += '<h6 class="mt-3 text-danger">Errores:</h6><ul>';
                data.errores.forEach(error => {
                    html += `<li class="text-danger">${error}</li>`;
                });
                html += '</ul>';
            }
            
            if (data.advertencias.length > 0) {
                html += '<h6 class="mt-3 text-warning">Advertencias:</h6><ul>';
                data.advertencias.forEach(advertencia => {
                    html += `<li class="text-warning">${advertencia}</li>`;
                });
                html += '</ul>';
            }
            
            html += '</div>';
            resultado.innerHTML = html;
        } else {
            resultado.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${data.error}</div>`;
        }
        resultado.classList.remove('d-none');
    })
    .catch(error => {
        console.error('Error:', error);
        const resultado = document.getElementById('resultadoValidacionModal');
        resultado.innerHTML = `<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`;
        resultado.classList.remove('d-none');
    });
}

// Variables globales para la calculadora de aportes
let ingredientesDisponibles = [];
let nutrientesDisponibles = [];

function abrirCalculadoraAportes() {
    // Crear modal dinámico para calculadora de aportes
    const modalHtml = `
        <div class="modal fade" id="calculadoraAportesModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-calculator me-2"></i>Calculadora de Aportes Nutricionales</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Información de la Fórmula</h6>
                                <div class="mb-3">
                                    <label class="form-label">Cargar Fórmula Existente (Opcional)</label>
                                    <select class="form-select" id="formulaExistente" onchange="cargarFormulaSeleccionada()">
                                        <option value="">-- Seleccionar fórmula existente --</option>
                                    </select>
                                    <small class="form-text text-muted">O crear una nueva fórmula abajo</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nombre de la Fórmula</label>
                                    <input type="text" class="form-control" id="nombreFormula" placeholder="Ej: Alimento para Bovinos">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Consumo por Animal (kg/día)</label>
                                    <input type="number" class="form-control" id="consumoAnimal" step="0.1" min="0.1" placeholder="Ej: 2.5">
                                </div>
                                
                                <h6 class="mt-4">Ingredientes de la Fórmula</h6>
                                <button type="button" class="btn btn-success btn-sm mb-3" onclick="agregarIngredienteAporte()">
                                    <i class="fas fa-plus me-1"></i>Agregar Ingrediente
                                </button>
                                <div id="ingredientesAporteModal">
                                    <!-- Los ingredientes se agregarán dinámicamente -->
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>Nutrientes a Analizar</h6>
                                <div class="mb-3">
                                    <div id="nutrientesSeleccionModal" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px; border-radius: 5px;">
                                        <div class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                            <p class="mt-2">Cargando nutrientes...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Seleccione los nutrientes que desea analizar en su fórmula
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div id="resultadoAportesModal" class="mt-4 d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-primary" onclick="calcularAportesNutricionales()">
                            <i class="fas fa-calculator me-1"></i>Calcular Aportes
                        </button>
                        <button type="button" class="btn btn-success d-none" id="btnImprimirAportes" onclick="imprimirAportes()">
                            <i class="fas fa-print me-1"></i>Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente si existe
    const existingModal = document.getElementById('calculadoraAportesModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Cargar datos iniciales
    cargarDatosIniciales();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('calculadoraAportesModal'));
    modal.show();
}

function cargarDatosIniciales() {
    // Cargar ingredientes
    fetch('/api/obtener_ingredientes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                ingredientesDisponibles = data.ingredientes;
            }
        })
        .catch(error => console.error('Error cargando ingredientes:', error));
    
    // Cargar nutrientes
    fetch('/api/obtener_nutrientes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                nutrientesDisponibles = data.nutrientes;
                mostrarNutrientesDisponibles();
            }
        })
        .catch(error => console.error('Error cargando nutrientes:', error));
    
    // Cargar fórmulas disponibles
    cargarFormulasEnDropdown();
}

function cargarFormulasEnDropdown() {
    fetch('/api/obtener_mezclas')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('formulaExistente');
            
            if (data.success && data.mezclas.length > 0) {
                data.mezclas.forEach(mezcla => {
                    const option = document.createElement('option');
                    option.value = mezcla.id;
                    option.textContent = `${mezcla.nombre} ${mezcla.tipo_animales ? `(${mezcla.tipo_animales})` : ''}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error cargando fórmulas:', error));
}

function mostrarNutrientesDisponibles() {
    const container = document.getElementById('nutrientesSeleccionModal');
    let html = '<div class="mb-2"><strong>Seleccione los nutrientes a analizar:</strong></div>';
    
    nutrientesDisponibles.forEach(nutriente => {
        html += `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${nutriente.id}" id="nutriente_${nutriente.id}">
                <label class="form-check-label" for="nutriente_${nutriente.id}">
                    ${nutriente.nombre} (${nutriente.unidad})
                </label>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function agregarIngredienteAporte() {
    const container = document.getElementById('ingredientesAporteModal');
    
    const ingredienteDiv = document.createElement('div');
    ingredienteDiv.className = 'row mb-3 ingrediente-aporte';
    
    let opcionesIngredientes = '<option value="">Seleccione un ingrediente</option>';
    ingredientesDisponibles.forEach(ing => {
        opcionesIngredientes += `<option value="${ing.id}">${ing.nombre}</option>`;
    });
    
    ingredienteDiv.innerHTML = `
        <div class="col-md-6">
            <select class="form-control" required>
                ${opcionesIngredientes}
            </select>
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control" placeholder="Porcentaje (%)" step="0.01" min="0" max="100" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngredienteAporte(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(ingredienteDiv);
}

function eliminarIngredienteAporte(btn) {
    btn.closest('.ingrediente-aporte').remove();
}

function calcularAportesNutricionales() {
    const nombreFormula = document.getElementById('nombreFormula').value || 'Fórmula sin nombre';
    const consumoAnimal = parseFloat(document.getElementById('consumoAnimal').value);
    
    // Obtener ingredientes
    const ingredientesDiv = document.querySelectorAll('.ingrediente-aporte');
    const ingredientes = [];
    
    ingredientesDiv.forEach(div => {
        const select = div.querySelector('select');
        const input = div.querySelector('input');
        const ingredienteId = select.value;
        const porcentaje = parseFloat(input.value);
        
        if (ingredienteId && !isNaN(porcentaje)) {
            ingredientes.push({
                id: ingredienteId,
                porcentaje: porcentaje
            });
        }
    });
    
    // Obtener nutrientes seleccionados
    const nutrientesSeleccionados = [];
    document.querySelectorAll('#nutrientesSeleccionModal input[type="checkbox"]:checked').forEach(checkbox => {
        nutrientesSeleccionados.push(parseInt(checkbox.value));
    });
    
    // Validaciones
    if (isNaN(consumoAnimal) || consumoAnimal <= 0) {
        mostrarResultadoAportes('<div class="alert alert-warning">Por favor ingrese un consumo por animal válido</div>');
        return;
    }
    
    if (ingredientes.length === 0) {
        mostrarResultadoAportes('<div class="alert alert-warning">Por favor agregue al menos un ingrediente</div>');
        return;
    }
    
    if (nutrientesSeleccionados.length === 0) {
        mostrarResultadoAportes('<div class="alert alert-warning">Por favor seleccione al menos un nutriente</div>');
        return;
    }
    
    // Realizar cálculo
    const datos = {
        nombre_formula: nombreFormula,
        consumo_animal: consumoAnimal,
        ingredientes: ingredientes,
        nutrientes_seleccionados: nutrientesSeleccionados
    };
    
    fetch('/api/calcular_aportes_nutricionales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datos)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarResultadosAportes(data);
            document.getElementById('btnImprimirAportes').classList.remove('d-none');
        } else {
            mostrarResultadoAportes(`<div class="alert alert-danger"><strong>Error:</strong> ${data.error}</div>`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarResultadoAportes(`<div class="alert alert-danger"><strong>Error:</strong> ${error.message}</div>`);
    });
}

function mostrarResultadoAportes(html) {
    const resultado = document.getElementById('resultadoAportesModal');
    resultado.innerHTML = html;
    resultado.classList.remove('d-none');
}

function mostrarResultadosAportes(data) {
    let html = `
        <div class="alert alert-success">
            <h5><strong>Resultados del Análisis Nutricional</strong></h5>
            <div class="row mb-3">
                <div class="col-md-3">
                    <strong>Fórmula:</strong> ${data.nombre_formula}
                </div>
                <div class="col-md-3">
                    <strong>Consumo/Animal:</strong> ${data.consumo_animal} kg/día
                </div>
                <div class="col-md-3">
                    <strong>Ingredientes:</strong> ${data.total_ingredientes}
                </div>
                <div class="col-md-3">
                    <strong>Nutrientes:</strong> ${data.total_nutrientes}
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Nutriente</th>
                        <th>Unidad</th>
                        <th>Aporte Total (%)</th>
                        <th>Consumo Diario</th>
                        <th>Detalle por Ingrediente</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.resultados.forEach(resultado => {
        html += `
            <tr>
                <td><strong>${resultado.nutriente_nombre}</strong></td>
                <td>${resultado.unidad}</td>
                <td class="text-center"><span class="badge bg-primary">${resultado.aporte_total}%</span></td>
                <td class="text-center"><span class="badge bg-success">${resultado.consumo_diario_total} ${resultado.unidad}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#detalle_${resultado.nutriente_id}">
                        <i class="fas fa-eye"></i> Ver Detalle
                    </button>
                </td>
            </tr>
            <tr class="collapse" id="detalle_${resultado.nutriente_id}">
                <td colspan="5">
                    <div class="table-responsive">
                        <table class="table table-sm table-borderless">
                            <thead>
                                <tr>
                                    <th>Ingrediente</th>
                                    <th>% en Fórmula</th>
                                    <th>Valor Nutricional</th>
                                    <th>Aporte</th>
                                    <th>Consumo Diario</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        resultado.detalle_ingredientes.forEach(detalle => {
            html += `
                <tr>
                    <td>${detalle.nombre}</td>
                    <td>${detalle.porcentaje}%</td>
                    <td>${detalle.valor_nutricional}%</td>
                    <td>${detalle.aporte}%</td>
                    <td>${detalle.consumo_diario} ${resultado.unidad}</td>
                </tr>
            `;
        });
        
        html += `
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    mostrarResultadoAportes(html);
}

function imprimirAportes() {
    // Obtener los datos del último cálculo
    const nombreFormula = document.getElementById('nombreFormula').value || 'Fórmula sin nombre';
    const consumoAnimal = document.getElementById('consumoAnimal').value || '0';
    
    // Contar ingredientes y nutrientes
    const totalIngredientes = document.querySelectorAll('.ingrediente-aporte').length;
    const totalNutrientes = document.querySelectorAll('#nutrientesSeleccionModal input[type="checkbox"]:checked').length;
    
    // Construir URL con parámetros
    const params = new URLSearchParams({
        nombre_formula: nombreFormula,
        consumo_animal: consumoAnimal,
        total_ingredientes: totalIngredientes,
        total_nutrientes: totalNutrientes
    });
    
    // Abrir nueva ventana para impresión
    const url = `/imprimir_aportes?${params.toString()}`;
    window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
}


function cargarFormulaSeleccionada() {
    const select = document.getElementById('formulaExistente');
    const mezclaId = select.value;
    
    if (!mezclaId) {
        // Si no hay selección, limpiar el formulario
        document.getElementById('nombreFormula').value = '';
        document.getElementById('ingredientesAporteModal').innerHTML = '';
        return;
    }
    
    fetch(`/api/obtener_detalle_mezcla/${mezclaId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cargar datos en el formulario principal
                document.getElementById('nombreFormula').value = data.mezcla.nombre;
                
                // Limpiar ingredientes existentes
                document.getElementById('ingredientesAporteModal').innerHTML = '';
                
                // Cargar ingredientes de la fórmula
                data.ingredientes.forEach(ingrediente => {
                    agregarIngredienteAporte();
                    
                    // Obtener el último ingrediente agregado
                    const ingredientesDiv = document.querySelectorAll('.ingrediente-aporte');
                    const ultimoIngrediente = ingredientesDiv[ingredientesDiv.length - 1];
                    
                    // Establecer valores
                    const select = ultimoIngrediente.querySelector('select');
                    const input = ultimoIngrediente.querySelector('input');
                    
                    select.value = ingrediente.ingrediente_id;
                    input.value = ingrediente.porcentaje;
                });
                
                mostrarNotificacion(`Fórmula "${data.mezcla.nombre}" cargada exitosamente`, 'success');
                
            } else {
                mostrarNotificacion(`Error: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion(`Error al cargar la fórmula: ${error.message}`, 'danger');
        });
}
</script>
{% endblock %}
